<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Display a map on a webpage</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.js"></script>
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.js'></script>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf/turf.min.js"></script>
<script src = "js/map1.js"></script>



<style>  
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    #direction-button {
        position: absolute;
        top: 15px;
        left: 15px;
        padding: 10px 20px;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        margin: 5px;
    }  
    #add-track-button{
        position: absolute;
        bottom: 15px;
        left: 15px;
        padding: 10px 20px;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        margin: 5px;       
    }

</style>
</head>
<body>
<div id="map"></div>
<button id="direction-button"> Directions </button>
<button id="add-track-button"> Add Track</button>
<script>
    let map;
    let coordinates = [];
    let routeGeometry = {};
    
    document.addEventListener('DOMContentLoaded', () => {
        axios.get('/config')
        .then( response => {
                const mapboxAccessToken = response.data.mapboxAccessToken;
                map = initializeMap(mapboxAccessToken);
                map = geoLocateTest(map);

                //if( map.isStyleLoaded() )
                //{
                //    calculateTimeAndDistance(map);
                //    //walkingRouteBetweenTwoCoords( map,mapboxAccessToken ); 
                //} else {
                //    map.once('load', () => {
                //       calculateTimeAndDistance(map);
                //        //walkingRouteBetweenTwoCoords( map,mapboxAccessToken );
                //    });
                //}
               

                // this is the functionality for clicking direction and then getting the route
                var directionButtonClicked = false;
                document.getElementById('direction-button').addEventListener('click', () => {
                    const coordinates = [];
                    var routeGeometry = {};
                    
                    if( !directionButtonClicked )
                    {
                        map.addLayer({
                            'id': 'route',
                            'type': 'line',
                            'source':  {
                                'type': 'geojson',
                                'data': {
                                    'type': 'Feature',
                                    'properties': {},
                                    'geometry': routeGeometry
                                }
                            },
                            'layout': {
                                'line-join': 'round',
                                'line-cap': 'round'
                            },
                            'paint': {
                                'line-color': '#888',
                                'line-width': 8
                            }
                        });  

                        map.on('click',(e)=>{
                            coordinates.push(e.lngLat);
                            alert( `you have clicked on ${coordinates[coordinates.length-1].lat} and ${coordinates[coordinates.length-1].lng}`);
                            
                            if( coordinates.length >= 2 ){

                                axios.post('/direction', { coordinates:coordinates })
                                .then( response => {
                                    routeGeometry = response.data.routeGeometry;
                                    console.log( routeGeometry );
                                    
                                    map.getSource('route').setData({
                                        'type': 'Feature',
                                        'properties': {},
                                        'geometry': routeGeometry
                                    })


                                    // for making the direction track clickable
                                    map.on('click', 'route', (e) => {
                                        const coordinates = e.lngLat;
                            
                                        // Display popup or perform any action
                                        new mapboxgl.Popup()
                                            .setLngLat(coordinates)
                                            .setHTML(`<p>Clicked on route at coordinates: ${coordinates.lng}, ${coordinates.lat}</p>`)
                                            .addTo(map);
                                    });
                            
                                    map.setCenter([coordinates[0].lng,coordinates[0].lat]);
                                })
                                .catch( error => {
                                    console.error(error);
                                })
                            }
                        });
                    }
                    directionButtonClicked = true;
                });
            })  
            .catch( error => {
                console.error(error);
            }); 

            // direction ends here :)


            // this is the functionality for adding track
            document.getElementById('add-track-button').addEventListener('click', onClickAddTrackButton);

    });



    // callback function for add-track-button
    async function onClickAddTrackButton(e){
        alert('add track button clicked');

        var trackResponseRecieved = false;
        coordinates = [];
        routeGeometry = {};

        map.addSource('routeAddTrack', {
            'type': 'geojson',
            'data': {
                'type': 'Feature',
                'properties': {},
                'geometry': routeGeometry
            }
        });

        map.addLayer({
            'id': 'routeAddTrack',
            'type': 'line',
            'source': 'routeAddTrack',
            'layout': {
                'line-join': 'round',
                'line-cap': 'round'
            },
            'paint': {
                'line-color': '#888',
                'line-width': 8
            }
        });

        map.on('click', mapOnClickDirectionApi);
        
        // map click event listeener removed after track added
        if( trackResponseRecieved ){
           map.off('click', mapOnClickDirectionApi);
        }

    }

    //callback function for map.on('click') eventlistener
    async function mapOnClickDirectionApi(e) {
        coordinates.push(e.lngLat);
        alert(`You have clicked on ${coordinates[coordinates.length - 1].lat} and ${coordinates[coordinates.length - 1].lng}`);
    
        if (coordinates.length >= 2) {
            try {
                // Post request to get the route
                const directionResponse = await axios.post('/direction', { coordinates: coordinates });
                const routeGeometry = directionResponse.data.routeGeometry;
                const routeDistance = directionResponse.data.distance;
                const routeDuration = directionResponse.data.duration;

                console.log(routeGeometry);
                console.log(routeDistance);
                console.log(routeDuration);

                map.getSource('routeAddTrack').setData({
                    'type': 'Feature',
                    'properties': {},
                    'geometry': routeGeometry
                });
    
                // For making the direction track clickable
                map.on('click', 'routeAddTrack', (e) => {
                    const coordinates = e.lngLat;
                    alert(`Clicked on route at coordinates: ${coordinates.lng}, ${coordinates.lat}`);
                    // Display popup or perform any action
                    new mapboxgl.Popup()
                        .setLngLat(coordinates)
                        .setHTML(`<p>Clicked on route at coordinates: ${coordinates.lng}, ${coordinates.lat}</p>`)
                        .addTo(map);
                });
    
                map.setCenter([coordinates[0].lng, coordinates[0].lat]);
    


                // Post request to send the route to the server
                const trackGeojson = map.getSource('routeAddTrack')._data;
                console.log( typeof trackGeojson );
                const addTrackResponse = await axios.post('/track/addTrack', { trackGeojson: trackGeojson, routeDistance: routeDistance, routeDuration: routeDuration });
    
                if (addTrackResponse.status === 200) {
                    alert('Track added successfully');
                    trackResponseRecieved = true;
                } else {
                    alert('Failed to add track');
                    trackResponseRecieved = true;
                    coordinates = [];
                    routeGeometry = {};
                }
            } catch (error) {
                console.error(error);
            }
        }
    }
</script>

</body>
</html>

